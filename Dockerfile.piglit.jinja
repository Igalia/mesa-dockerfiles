#
# This builds and installs Piglit. Requires `docker-jinja`.
#
# ~~~
#  dj -d Dockerfile.piglit.jinja -o Dockerfile        \
#    -e RELEASE=master   # master, 17.0, 13.0         \
#    [-e MAKEFLAGS=-j2]  # -j2, -j4 ...
#  docker build --pull -f Dockerfile -t igalia/mesa:piglit .
#  rm Dockerfile
# ~~~
#
# To run
#
# ~~~
#   mkdir -p -m 0777 ~/my_results_dir
#   docker run --privileged --rm -t -v ~/my_results_dir:/results:Z  -e DISPLAY=unix$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix igalia/mesa:piglit
# ~~~
#

FROM igalia/mesa:{{ RELEASE }}

LABEL maintainer "Juan A. Suarez Romero <jasuarez@igalia.com>"

RUN apt-get update                                                      \
  && apt-get -y --no-install-recommends install cmake libwaffle-dev     \
    libpng-dev libxkbcommon-dev libglu1-mesa-dev libegl1-mesa-dev       \
    ccache python3-setuptools python3-pip                               \
  && rm -fr /var/lib/apt/lists/*

RUN pip3 install numpy six mako

USER local

{% if MAKEFLAGS %}
ENV MAKEFLAGS={{ MAKEFLAGS }}
{% endif %}

RUN wget -c https://raw.githubusercontent.com/tanty/mesa-resources/master/testing/full-piglit-run.sh

RUN chmod +x full-piglit-run.sh

RUN git clone --depth 1 git://anongit.freedesktop.org/piglit /home/local/piglit

WORKDIR /home/local/piglit

RUN git show --stat > /home/local/piglit-head.txt

RUN cmake . && make

VOLUME /results

ENV PATH=/usr/lib/ccache:$PATH

ENV CCACHE_DIR=/results/docker-ccache

ENV CCACHE_UMASK=002

CMD [ "/bin/sh", "-c", "cat /home/local/mesa-head.txt >> /results/mesa-head.txt && cat /home/local/piglit-head.txt >> /results/piglit-head.txt && export MESA_COMMIT=$(grep commit /home/local/mesa-head.txt | cut -d \" \" -f 2) && export FPR_RUN_PIGLIT=true && export FPR_PIGLIT_PATH=/home/local/piglit && export FPR_PIGLIT_REPORTS_PATH=/results && /home/local/full-piglit-run.sh i965 $MESA_COMMIT && /home/local/full-piglit-run.sh llvmpipe $MESA_COMMIT && /home/local/full-piglit-run.sh swr $MESA_COMMIT && /home/local/full-piglit-run.sh softpipe $MESA_COMMIT" ]
